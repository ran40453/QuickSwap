<script type="text/babel">
    /**
     * QuickSwap Frontend Logic (Dynamic Binding Version)
     */
    const { useState, useEffect, useMemo, useCallback } = React;

    const STORAGE_KEY = 'quickswap_spreadsheet_id';

    // --- Inline SVG Icons ---
    const Icon = ({ children, size = 20, className = "" }) => (
        <svg
            width={size} height={size} viewBox="0 0 24 24" fill="none"
            stroke="currentColor" strokeWidth="2" strokeLinecap="round"
            strokeLinejoin="round" className={className}
        >
            {children}
        </svg>
    );

    const RefreshCw = (props) => (
        <Icon {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></Icon>
    );
    const TrendingUp = (props) => (
        <Icon {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></Icon>
    );
    const ArrowRightLeft = (props) => (
        <Icon {...props}><path d="m16 3 4 4-4 4" /><path d="M20 7H4" /><path d="m8 21-4-4 4-4" /><path d="M4 17h16" /></Icon>
    );
    const Search = (props) => (
        <Icon {...props}><circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" /></Icon>
    );
    const ExternalLink = (props) => (
        <Icon {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" /><polyline points="15 3 21 3 21 9" /><line x1="10" y1="14" x2="21" y2="3" /></Icon>
    );
    const Calculator = (props) => (
        <Icon {...props}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" /></Icon>
    );
    const History = (props) => (
        <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><polyline points="12 7 12 12 15 15" /></Icon>
    );
    const TrendingDown = (props) => (
        <Icon {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6" /><polyline points="17 18 23 18 23 12" /></Icon>
    );
    const PlusCircle = (props) => (
        <Icon {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" /></Icon>
    );
    const Trash2 = (props) => (
        <Icon {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></Icon>
    );
    const X = (props) => (
        <Icon {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></Icon>
    );
    const ChevronRight = (props) => (
        <Icon {...props}><polyline points="9 18 15 12 9 6" /></Icon>
    );
    const DollarSign = (props) => (
        <Icon {...props}><line x1="12" y1="1" x2="12" y2="23" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></Icon>
    );
    const Settings2 = (props) => (
        <Icon {...props}><path d="M20 7h-9" /><path d="M14 17H5" /><circle cx="17" cy="17" r="3" /><circle cx="7" cy="7" r="3" /></Icon>
    );
    const Copy = (props) => (
        <Icon {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></Icon>
    );
    const Check = (props) => (
        <Icon {...props}><polyline points="20 6 9 17 4 12" /></Icon>
    );

    // --- Components ---

    const CurrencyCard = ({ code, amount, onAmountChange, onEditClick, isActive }) => {
        const config = CURRENCY_CONFIG?.[code] || { code, name: "Unknown", symbol: "", flag: "❓" };
        const formatNumber = (num) => {
            if (typeof num !== 'number') return "0";
            return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        };

        return (
            <div
                className={`p-4 rounded-3xl transition-all h-full flex flex-col justify-between ${isActive ? 'neu-inset ring-2 ring-indigo-400/20' : 'neu-flat hover:scale-[1.02]'}`}
                onClick={() => onAmountChange(amount)}
            >
                <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2 overflow-hidden">
                        <span className="text-xl shrink-0 drop-shadow-sm">{config.flag}</span>
                        <div className="overflow-hidden">
                            <h3 className="font-bold text-slate-700 leading-tight text-xs truncate">{config.code}</h3>
                            <p className="text-[9px] text-slate-500 truncate">{config.name}</p>
                        </div>
                    </div>
                    <button
                        onClick={(e) => { e.stopPropagation(); onEditClick(); }}
                        className="p-1.5 neu-flat-sm rounded-lg text-slate-400 hover:text-indigo-600 transition-colors"
                    >
                        <Settings2 size={12} />
                    </button>
                </div>

                <div className="relative">
                    <div className="flex items-baseline gap-1 mb-0.5">
                        <span className="text-[10px] font-bold text-indigo-500">{config.symbol}</span>
                        <input
                            type="number"
                            inputMode="decimal"
                            value={amount === 0 ? "" : (code === 'BTC' || code === 'ETH' ? (amount < 1 ? amount.toFixed(6) : amount.toFixed(2)) : amount.toFixed(2).replace(/\.00$/, ''))}
                            onChange={(e) => onAmountChange(parseFloat(e.target.value) || 0)}
                            onClick={(e) => e.stopPropagation()}
                            className="w-full text-lg font-black bg-transparent border-none outline-none focus:ring-0 p-0 text-slate-800"
                            placeholder="0"
                        />
                    </div>
                    <div className="text-[9px] text-slate-400 font-medium italic truncate">
                        {amount < 0.001 ? amount.toFixed(8) : formatNumber(amount)}
                    </div>
                </div>
            </div>
        );
    };

    /**
     * Onboarding Screen
     */
    const Onboarding = ({ onComplete }) => {
        const [inputValue, setInputValue] = useState('');
        const [parsedId, setParsedId] = useState('');

        useEffect(() => {
            // Regex to match Google Sheet ID from URL or extract it from raw string
            const idMatch = inputValue.match(/\/d\/([a-zA-Z0-9-_]{25,})/);
            if (idMatch && idMatch[1]) {
                setParsedId(idMatch[1]);
            } else if (inputValue.length > 25 && !inputValue.includes('/')) {
                setParsedId(inputValue);
            } else {
                setParsedId('');
            }
        }, [inputValue]);

        const handleStart = () => {
            if (parsedId) {
                // Admin Logging: Record the binding action
                if (typeof google !== 'undefined') {
                    google.script.run.logSpreadsheetAccess(parsedId, 'BINDING', navigator.userAgent);
                }
                onComplete(parsedId);
            } else {
                alert("請貼上有效的 Google Sheet 連結或 ID");
            }
        };

        return (
            <div className="min-h-screen flex items-center justify-center p-6 animate-fadeIn">
                <div className="neu-flat w-full max-w-sm rounded-[3rem] p-8 space-y-8 flex flex-col items-center text-center">
                    <div className="p-5 neu-flat rounded-3xl">
                        <ArrowRightLeft size={40} className="text-indigo-600" />
                    </div>

                    <div className="space-y-2">
                        <h1 className="text-2xl font-black text-slate-800 tracking-tight">歡迎使用 QuickSwap</h1>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest leading-relaxed">
                            開始前，請綁定您的專屬資料庫
                        </p>
                    </div>

                    <div className="w-full space-y-6">
                        <div className="neu-inset p-5 rounded-3xl text-left space-y-3">
                            <div className="flex items-center gap-3">
                                <div className="w-6 h-6 rounded-full bg-indigo-500 text-white flex items-center justify-center text-[10px] font-bold">1</div>
                                <p className="text-[11px] font-bold text-slate-600">建立一個新的 Google Sheet</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="w-6 h-6 rounded-full bg-indigo-500 text-white flex items-center justify-center text-[10px] font-bold">2</div>
                                <p className="text-[11px] font-bold text-slate-600 truncate">直接貼上整段網址連結即可</p>
                            </div>
                        </div>

                        <div className="space-y-3">
                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 block text-left">貼上試算表連結或 ID</label>
                            <div className="neu-inset rounded-2xl px-4 py-4 flex items-center">
                                <input
                                    type="text"
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    placeholder="https://docs.google.com/spreadsheets/d/..."
                                    className="w-full bg-transparent border-none font-bold text-sm focus:ring-0 outline-none placeholder-slate-300"
                                />
                            </div>
                            {parsedId && (
                                <p className="text-[10px] text-emerald-500 font-bold italic animate-pulse">
                                    ✓ 已成功自動識別試算表 ID
                                </p>
                            )}
                            <p className="text-[9px] text-slate-400 font-medium leading-relaxed italic">
                                * 本 App 不會公開您的資料，僅儲存於您指定的試算表中。
                            </p>
                        </div>

                        <button
                            onClick={handleStart}
                            className="w-full py-5 neu-flat rounded-[1.8rem] text-indigo-600 font-black text-sm uppercase tracking-widest flex items-center justify-center gap-3 active:scale-95 transition-all outline-none"
                        >
                            完成綁定並開始 <ChevronRight size={18} />
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    // --- Main App ---

    const App = () => {
        const [spreadsheetId, setSpreadsheetId] = useState(localStorage.getItem(STORAGE_KEY));
        const [activeTab, setActiveTab] = useState('exchange');
        const [rates, setRates] = useState({
            USD: 1, TWD: 32.5, CNY: 7.24, VND: 25400, HKD: 7.8, KRW: 1350, JPY: 155, EUR: 0.92, GBP: 0.78,
            lastUpdated: "正在載入..."
        });
        const [baseAmount, setBaseAmount] = useState(100);
        const [activeCurrency, setActiveCurrency] = useState('USD');
        const [isLoading, setIsLoading] = useState(true);
        const [historyFilter, setHistoryFilter] = useState('ALL');
        const [transactions, setTransactions] = useState([]);

        // UI State
        const [visibleCurrencies, setVisibleCurrencies] = useState(['USD', 'TWD', 'CNY', 'VND', 'HKD', 'KRW']);
        const [isEditingIdx, setIsEditingIdx] = useState(null);
        const [searchTerm, setSearchTerm] = useState('');
        const [showOptions, setShowOptions] = useState(false);

        // Comparison Tool State (Moved to top to prevent NaN in useMemo calculation)
        const [offerFrom, setOfferFrom] = useState('TWD');
        const [offerTo, setOfferTo] = useState('VND');
        const [offerAmountFrom, setOfferAmountFrom] = useState(1000);
        const [offerAmountTo, setOfferAmountTo] = useState(780000);

        useEffect(() => {
            if (spreadsheetId) {
                updateRates();
                loadTransactions();
                // Admin Logging: Record the access action
                if (typeof google !== 'undefined') {
                    google.script.run.logSpreadsheetAccess(spreadsheetId, 'ACCESS', navigator.userAgent);
                }
            }
        }, [spreadsheetId]);

        const updateRates = () => {
            setIsLoading(true);
            if (typeof google === 'undefined') {
                setIsLoading(false);
                return;
            }
            google.script.run
                .withSuccessHandler((data) => {
                    if (data && data.rates) {
                        setRates(data.rates);
                    }
                    setIsLoading(false);
                })
                .withFailureHandler((err) => {
                    console.error("Fetch rates failed:", err);
                    setIsLoading(false);
                })
                .fetchLiveRates();
        };

        const loadTransactions = (showLoading = false) => {
            if (typeof google === 'undefined') return;
            if (showLoading) setIsLoading(true);
            console.log("正在載入歷史紀錄，試算表 ID:", spreadsheetId);
            google.script.run
                .withSuccessHandler((data) => {
                    if (data) {
                        console.log("成功載入歷史紀錄數:", data.length);
                        setTransactions(data);
                    }
                    if (showLoading) setIsLoading(false);
                })
                .withFailureHandler((err) => {
                    console.error("載入歷史紀錄失敗:", err);
                    if (showLoading) setIsLoading(false);
                })
                .getTransactions(spreadsheetId);
        };

        const handleAmountChange = (code, value) => {
            setActiveCurrency(code);
            const rawRate = rates[code];
            const rate = (rawRate && typeof rawRate === 'number') ? rawRate : (code === 'USD' ? 1 : 32.5);
            setBaseAmount(value / rate);
        };

        const getAmount = (code) => {
            const rate = rates[code] || 1;
            return baseAmount * rate;
        };

        const saveTransaction = () => {
            const marketRate = (rates[offerTo] || 1) / (rates[offerFrom] || 1);
            const friendRate = offerAmountTo / offerAmountFrom;
            const diffPercent = ((friendRate - marketRate) / marketRate) * 100;

            const newTx = {
                id: Date.now().toString(),
                date: new Date().toLocaleString('zh-TW'),
                fromCode: offerFrom,
                toCode: offerTo,
                fromAmount: offerAmountFrom,
                toAmount: offerAmountTo,
                marketRate: marketRate,
                diffPercent: diffPercent,
                note: ""
            };

            if (typeof google !== 'undefined') {
                google.script.run
                    .withSuccessHandler(() => {
                        setTransactions([newTx, ...transactions]);
                        alert("已儲存紀錄到 Google Sheets！");
                    })
                    .saveTransaction(newTx, spreadsheetId);
            } else {
                setTransactions([newTx, ...transactions]);
                alert("已模擬儲存 (Local)");
            }
        };

        const deleteTransaction = (id) => {
            if (confirm("確定要刪除這筆紀錄嗎？(將同步從 Google Sheets 刪除)")) {
                if (typeof google !== 'undefined') {
                    google.script.run
                        .withSuccessHandler(() => {
                            setTransactions(transactions.filter(t => t.id !== id));
                        })
                        .deleteTransaction(id, spreadsheetId);
                } else {
                    setTransactions(transactions.filter(t => t.id !== id));
                }
            }
        };

        const handleOnboardingComplete = (id) => {
            localStorage.setItem(STORAGE_KEY, id);
            setSpreadsheetId(id);
        };

        const resetBinding = () => {
            if (confirm("確定要解除目前的試算表綁定嗎？這不會刪除資料，但您需要重新輸入 ID。")) {
                localStorage.removeItem(STORAGE_KEY);
                setSpreadsheetId(null);
                setShowOptions(false);
            }
        };

        const stats = useMemo(() => {
            let totalTWD = 0;
            transactions.forEach(tx => {
                const marketToAmount = tx.fromAmount * tx.marketRate;
                const profitInTarget = tx.toAmount - marketToAmount;
                const currentRateTWD = rates['TWD'] || 32.5;
                const currentRateTarget = rates[tx.toCode] || 1;
                const profitInTWD = profitInTarget * (currentRateTWD / currentRateTarget);
                totalTWD += profitInTWD;
            });
            return { totalTWD };
        }, [transactions, rates]);

        const filteredTransactions = useMemo(() => {
            if (historyFilter === 'ALL') return transactions;
            return transactions.filter(t => t.fromCode === historyFilter || t.toCode === historyFilter);
        }, [transactions, historyFilter]);

        const filteredCurrenciesModal = useMemo(() => {
            const all = Object.keys(CURRENCY_CONFIG);
            if (!searchTerm) return all;
            return all.filter(code =>
                code.toLowerCase().includes(searchTerm.toLowerCase()) ||
                CURRENCY_CONFIG[code].name.includes(searchTerm)
            );
        }, [searchTerm]);

        const currentMarketRate = (rates[offerTo] || 1) / (rates[offerFrom] || 1);
        const currentFriendRate = (offerAmountFrom === 0) ? 0 : (offerAmountTo / offerAmountFrom);
        const currentDiffPercent = currentMarketRate === 0 ? 0 : (((currentFriendRate - currentMarketRate) / currentMarketRate) * 100);
        const isBetterForMe = currentDiffPercent > 0;

        const formatBetterRate = (val) => {
            if (!val) return "0.00";
            if (val < 0.001) return val.toFixed(8);
            if (val < 1) return val.toFixed(4);
            return val.toFixed(2);
        };

        // Header Date Logic
        const todayStr = useMemo(() => {
            const now = new Date();
            const options = { day: '2-digit', month: 'short', year: '2-digit' };
            const formatted = now.toLocaleDateString('en-GB', options).replace(/ /g, '');
            return formatted + " Powered by Cody";
        }, []);

        if (!spreadsheetId) {
            return <Onboarding onComplete={handleOnboardingComplete} />;
        }

        return (
            <div className="app-container px-4 max-w-lg mx-auto overflow-x-hidden">
                {/* Header */}
                <div className="flex items-center justify-between mb-8">
                    <div className="flex items-center gap-3">
                        <div
                            className="p-3 neu-flat rounded-2xl active:neu-inset transition-all cursor-pointer"
                            onClick={() => setShowOptions(!showOptions)}
                        >
                            <ArrowRightLeft className="text-indigo-600" size={20} />
                        </div>
                        <div>
                            <h1 className="text-xl font-black text-slate-800 tracking-tight">QuickSwap</h1>
                            <p className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">{todayStr}</p>
                        </div>
                    </div>
                    <button
                        onClick={updateRates}
                        className="p-4 neu-flat rounded-2xl active:scale-95 transition-all outline-none"
                    >
                        <RefreshCw className={`${isLoading ? 'animate-spin text-indigo-500' : 'text-slate-500'}`} size={20} />
                    </button>
                </div>

                {/* Floating Options Menu */}
                {showOptions && (
                    <div className="absolute top-28 left-4 z-[100] animate-fadeIn">
                        <div className="neu-flat rounded-2xl p-2 w-48 space-y-1">
                            <button
                                onClick={resetBinding}
                                className="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-50 text-[11px] font-bold text-rose-500 flex items-center gap-2"
                            >
                                <RefreshCw size={14} /> 解除試算表綁定
                            </button>
                            <div className="px-4 py-2 border-t border-slate-100 italic text-[9px] text-slate-400">
                                ID: {spreadsheetId.substring(0, 10)}...
                            </div>
                        </div>
                    </div>
                )}

                <main>
                    {/* TAB 1: EXCHANGE */}
                    {activeTab === 'exchange' && (
                        <div className="space-y-8 animate-fadeIn">
                            <div className="grid grid-cols-2 gap-5">
                                {visibleCurrencies.map((code, idx) => (
                                    <CurrencyCard
                                        key={`${code}-${idx}`}
                                        code={code}
                                        amount={getAmount(code)}
                                        onAmountChange={(val) => handleAmountChange(code, val)}
                                        onEditClick={() => setIsEditingIdx(idx)}
                                        isActive={activeCurrency === code}
                                    />
                                ))}
                            </div>

                            <div className="text-center pt-8 space-y-1">
                                <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest block">
                                    最後更新：{rates.lastUpdated}
                                </span>
                                <span className="text-[8px] font-bold text-slate-200 uppercase tracking-tighter block">
                                    Ver: 1.0.6-UIUpdate
                                </span>
                            </div>
                        </div>
                    )}

                    {/* TAB 2: ADD (Comparison Tool) */}
                    {activeTab === 'add' && (
                        <div className="space-y-6 animate-fadeIn">
                            <div className="neu-flat p-6 rounded-[2.5rem] space-y-6">
                                <div className="space-y-5">
                                    <div className="space-y-3">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">給出幣別</label>
                                        <div className="flex gap-3">
                                            <div className="neu-inset rounded-2xl px-3 py-2 flex items-center">
                                                <select value={offerFrom} onChange={(e) => setOfferFrom(e.target.value)} className="bg-transparent border-none font-black text-sm focus:ring-0 outline-none">
                                                    {CURRENCY_CONFIG && Object.keys(CURRENCY_CONFIG).map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                            </div>
                                            <div className="flex-1 neu-inset rounded-2xl px-4 py-3">
                                                <input type="number" value={offerAmountFrom} onChange={(e) => setOfferAmountFrom(parseFloat(e.target.value) || 0)} className="w-full bg-transparent border-none text-lg font-black focus:ring-0 outline-none" />
                                                <div className="text-[9px] font-bold text-slate-400 uppercase mt-0.5">
                                                    友情報價 1 : {formatBetterRate(currentFriendRate)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex justify-center">
                                        <div className="p-3 neu-flat-sm rounded-full"><ArrowRightLeft className="text-slate-400 rotate-90" size={16} /></div>
                                    </div>

                                    <div className="space-y-3">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">得到幣別</label>
                                        <div className="flex gap-3">
                                            <div className="neu-inset rounded-2xl px-3 py-2 flex items-center">
                                                <select value={offerTo} onChange={(e) => setOfferTo(e.target.value)} className="bg-transparent border-none font-black text-sm focus:ring-0 outline-none">
                                                    {CURRENCY_CONFIG && Object.keys(CURRENCY_CONFIG).map(c => <option key={c} value={c}>{c}</option>)}
                                                </select>
                                            </div>
                                            <div className="flex-1 neu-inset rounded-2xl px-4 py-3">
                                                <input type="number" value={offerAmountTo} onChange={(e) => setOfferAmountTo(parseFloat(e.target.value) || 0)} className="w-full bg-transparent border-none text-lg font-black focus:ring-0 outline-none" />
                                                <div className="text-[9px] font-bold text-slate-400 uppercase mt-0.5">
                                                    市場匯率 1 : {formatBetterRate(currentMarketRate)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="neu-inset p-6 rounded-[2rem] flex flex-col items-center gap-3 transition-all">
                                    <div className="flex items-center gap-2">
                                        {isBetterForMe ? <TrendingUp className="text-emerald-500" size={20} /> : <TrendingDown className="text-rose-500" size={20} />}
                                        <span className={`font-black text-sm uppercase ${isBetterForMe ? 'text-emerald-600' : 'text-rose-600'}`}>
                                            {isBetterForMe ? '較市場划算' : '較市場昂貴'}
                                        </span>
                                    </div>
                                    <div className={`text-5xl font-black ${isBetterForMe ? 'text-emerald-500' : 'text-rose-500'} neu-text-shadow`}>
                                        {Math.abs(currentDiffPercent).toFixed(2)}%
                                    </div>
                                </div>

                                <button
                                    onClick={saveTransaction}
                                    className="w-full py-5 neu-flat rounded-[1.8rem] text-indigo-600 font-black text-sm uppercase tracking-widest flex items-center justify-center gap-3 active:scale-95 transition-all outline-none"
                                >
                                    <PlusCircle size={20} /> 儲存至 Google Sheet
                                </button>
                            </div>
                        </div>
                    )}

                    {/* TAB 3: HISTORY */}
                    {activeTab === 'history' && (
                        <div className="space-y-6 animate-fadeIn">
                            <div className="neu-flat p-6 rounded-[2rem] flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-3 neu-inset rounded-2xl">
                                        <DollarSign className="text-indigo-500" size={20} />
                                    </div>
                                    <div>
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">總盈虧累計 (TWD)</p>
                                        <h3 className={`text-2xl font-black ${stats.totalTWD >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                            {stats.totalTWD >= 0 ? '+' : ''}{stats.totalTWD.toFixed(2)}
                                        </h3>
                                    </div>
                                </div>
                                <button
                                    onClick={() => loadTransactions(true)}
                                    className="p-4 neu-flat rounded-2xl active:scale-95 transition-all outline-none"
                                    title="同步試算表歷史紀錄"
                                >
                                    <RefreshCw className={`${isLoading ? 'animate-spin text-indigo-500' : 'text-slate-400'}`} size={18} />
                                </button>
                            </div>

                            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                {['ALL', ...Object.keys(CURRENCY_CONFIG)].map(c => (
                                    <button
                                        key={c}
                                        onClick={() => setHistoryFilter(c)}
                                        className={`px-4 py-2 rounded-xl text-[10px] font-black transition-all shrink-0 ${historyFilter === c ? 'neu-inset text-indigo-600' : 'neu-flat-sm text-slate-400'} outline-none`}
                                    >
                                        {c === 'ALL' ? '全部' : c}
                                    </button>
                                ))}
                            </div>

                            {filteredTransactions.length === 0 ? (
                                <div className="py-20 neu-inset rounded-[2rem] text-center text-slate-300 font-bold italic">尚無交易紀錄</div>
                            ) : (
                                <div className="space-y-4">
                                    {filteredTransactions.map(tx => (
                                        <div key={tx.id} className="neu-flat p-5 rounded-3xl flex items-center justify-between group">
                                            <div className="flex items-center gap-4">
                                                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${tx.diffPercent > 0 ? 'neu-inset text-emerald-500' : 'neu-inset text-rose-500'}`}>
                                                    {tx.diffPercent > 0 ? <TrendingUp size={20} /> : <TrendingDown size={20} />}
                                                </div>
                                                <div>
                                                    <div className="flex items-center gap-2 font-black text-slate-700 text-sm">
                                                        {tx.fromAmount} {tx.fromCode} <ChevronRight className="text-slate-300" size={12} /> {tx.toAmount} {tx.toCode}
                                                    </div>
                                                    <div className="text-[10px] text-slate-400 font-bold uppercase mt-1">
                                                        {tx.date?.split(' ')?.[0]} • 價差 {Math.abs(tx.diffPercent).toFixed(2)}%
                                                    </div>
                                                </div>
                                            </div>
                                            <button onClick={() => deleteTransaction(tx.id)} className="p-3 neu-flat-sm rounded-xl text-slate-300 hover:text-rose-500 transition-all outline-none">
                                                <Trash2 size={16} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </main>

                {/* Navigation TabBar */}
                <nav className="fixed bottom-6 left-6 right-6 h-20 neu-flat rounded-[2rem] flex justify-around items-center px-4 z-50">
                    <button onClick={() => setActiveTab('exchange')} className={`flex flex-col items-center gap-1 transition-all p-3 rounded-2xl ${activeTab === 'exchange' ? 'neu-inset text-indigo-600 scale-105' : 'text-slate-400'} outline-none`}>
                        <Calculator size={20} />
                        <span className="text-[9px] font-black uppercase tracking-tighter">換算</span>
                    </button>
                    <button onClick={() => setActiveTab('add')} className={`flex flex-col items-center gap-1 transition-all p-3 rounded-2xl ${activeTab === 'add' ? 'neu-inset text-indigo-600 scale-105' : 'text-slate-400'} outline-none`}>
                        <PlusCircle size={20} />
                        <span className="text-[9px] font-black uppercase tracking-tighter">新增</span>
                    </button>
                    <button onClick={() => setActiveTab('history')} className={`flex flex-col items-center gap-1 transition-all p-3 rounded-2xl ${activeTab === 'history' ? 'neu-inset text-indigo-600 scale-105' : 'text-slate-400'} outline-none`}>
                        <History size={20} />
                        <span className="text-[9px] font-black uppercase tracking-tighter">歷史</span>
                    </button>
                </nav>

                {/* Edit Currency Modal */}
                {isEditingIdx !== null && (
                    <div className="fixed inset-0 bg-slate-900/10 backdrop-blur-md z-[100] flex items-center justify-center p-6">
                        <div className="neu-flat rounded-[3rem] w-full max-w-sm h-[80vh] flex flex-col p-8 animate-fadeIn">
                            <div className="flex items-center justify-between mb-6">
                                <h3 className="font-black text-slate-700 uppercase tracking-widest text-sm">切換幣別</h3>
                                <button onClick={() => { setIsEditingIdx(null); setSearchTerm(''); }} className="p-2 neu-flat-sm rounded-full active:scale-90 transition-all outline-none"><X size={16} /></button>
                            </div>

                            <div className="mb-6 relative">
                                <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
                                    <Search size={16} />
                                </div>
                                <input
                                    type="text"
                                    placeholder="快速查找幣別..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full pl-12 pr-4 py-4 neu-inset rounded-2xl bg-transparent border-none font-bold text-sm focus:ring-2 focus:ring-indigo-400/20 outline-none"
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4 overflow-y-auto pr-2 no-scrollbar flex-1">
                                {filteredCurrenciesModal.map(code => {
                                    const config = CURRENCY_CONFIG[code];
                                    const isVisibleInList = visibleCurrencies.includes(code);
                                    return (
                                        <button
                                            key={code}
                                            onClick={() => {
                                                const newVisible = [...visibleCurrencies];
                                                newVisible[isEditingIdx] = code;
                                                setVisibleCurrencies(newVisible);
                                                setIsEditingIdx(null);
                                                setSearchTerm('');
                                            }}
                                            disabled={isVisibleInList}
                                            className={`p-4 rounded-[1.5rem] flex flex-col items-center justify-center gap-2 transition-all h-[110px] ${isVisibleInList ? 'neu-inset opacity-40 cursor-not-allowed' : 'neu-flat-sm active:neu-inset hover:bg-slate-50'}`}
                                        >
                                            <span className="text-2xl drop-shadow-sm">{config.flag}</span>
                                            <span className="text-[10px] font-black text-slate-600">{config.code}</span>
                                            <span className="text-[9px] font-medium text-slate-400">{config.name}</span>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    };

    /**
     * Initialize App
     */
    const mountApp = () => {
        const rootElement = document.getElementById('root');
        if (rootElement) {
            try {
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);
            } catch (e) {
                console.error("Mounting Error:", e);
            }
        } else {
            setTimeout(mountApp, 100);
        }
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', mountApp);
    } else {
        mountApp();
    }
</script>